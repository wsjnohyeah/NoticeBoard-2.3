!function(t){"use strict";function e(){this.paused=!0,this.isHide=!1,this.initContainer=!0,this.duration=4,this._speed=144,this.requestID=0,this.position=0,this.runline=[],this.comments=[],this._resetRange()}function i(){return[{range:0,time:-9007199254740991,width:9007199254740991,height:0},{range:9007199254740991,time:9007199254740991,width:0,height:0}]}e.prototype.init=function(t){var e=this;if(!t.video&&!t.container)return void console.error("Container required.");this.comments=JSON.parse(JSON.stringify(t.comments||[])),this.comments.sort(function(t,e){return t.time-e.time});for(var i=this.comments.length-1;i>=0;i--)o(this.comments[i]);if(this.container=t.container,this.media=t.video||t.audio,this.engine=(t.engine||"DOM").toLowerCase(),this.useCanvas="canvas"===this.engine,this.isMedia=this.media?!0:!1,this.isVideo=t.video?!0:!1,this.isMedia&&(this.media.addEventListener("play",function(){e._play()}),this.media.addEventListener("pause",function(){e._pause()}),this.media.addEventListener("seeking",function(){e._seek()})),this.isVideo&&!this.container){var s=!this.media.paused;this.container=document.createElement("div"),this.initContainer=!1,this.container.style.position=this.media.style.position,this.media.style.position="absolute",this.media.parentNode.insertBefore(this.container,this.media),this.container.appendChild(this.media),s&&this.media.paused&&this.media.play()}return this.useCanvas?(this.stage=document.createElement("canvas"),this.stage.context=this.stage.getContext("2d"),this.stage.style.cssText="pointer-events:none;position:absolute;"):(this.stage=document.createElement("div"),this.stage.style.cssText="position:relative;overflow:hidden;pointer-events:none;transform:translateZ(0);"),this.stage.className="Danmaku-stage",this.resize(),this.container.appendChild(this.stage),this.isMedia&&this.media.paused||(this._seek(),this._play()),this},e.prototype.show=function(){return this.isHide?(this.isHide=!1,this._seek(),this._play(),this):this},e.prototype.hide=function(){return this.isHide?this:(this._pause(),this._clear(),this.isHide=!0,this)},e.prototype.resize=function(){return this.initContainer&&(this.width=this.container.offsetWidth,this.height=this.container.offsetHeight),!this.isVideo||this.initContainer&&this.width&&this.height||(this.width=this.media.clientWidth,this.height=this.media.clientHeight),this.useCanvas?(this.stage.width=this.width,this.stage.height=this.height):(this.stage.style.width=this.width+"px",this.stage.style.height=this.height+"px"),this.duration=this.width/this._speed,this},e.prototype.emit=function(t){if(o(t),this.isMedia){var e=this.media.currentTime;t.time=t.time||e,this.comments.splice(h(this.comments,e)+1,0,t)}else t.time=(new Date).getTime()/1e3,this.comments.push(t);return this},Object.defineProperty(e.prototype,"speed",{get:function(){return this._speed},set:function(t){this.width&&(this.duration=this.width/t),this._speed=t}}),e.prototype._play=function(){function t(){for(var e=i.isMedia?i.media.currentTime:(new Date).getTime()/1e3,n=i.runline.length-1;n>=0;n--){var h=i.runline[n];e-h.time>i.duration&&(i.stage.removeChild(h.node),i.runline.splice(n,1))}for(var o=[],r=document.createDocumentFragment();i.position<i.comments.length&&i.comments[i.position].time<e;){var h=i.comments[i.position];h.node=h.node||a(h),i.runline.push(h),o.push(h),r.appendChild(h.node),++i.position}o.length&&i.stage.appendChild(r);for(var n=o.length-1;n>=0;n--){var h=o[n];h.width=h.width||h.node.offsetWidth,h.height=h.height||h.node.offsetHeight}for(var n=o.length-1;n>=0;n--){var h=o[n];("top"===h.mode||"bottom"===h.mode)&&(h.x=i.width-h.width>>1),h.y=i._getY(h),h.node.style.cssText+=d(h.x,h.y)}for(var n=i.runline.length-1;n>=0;n--){var h=i.runline[n];if("top"!==h.mode&&"bottom"!==h.mode){var m=(i.width+h.width)*(e-h.time)/i.duration;"ltr"===h.mode&&(h.x=m-h.width),"rtl"===h.mode&&(h.x=i.width-m),h.node.style.cssText+=d(h.x,h.y)}}i.requestID=s(t)}function e(){var t=i.isMedia?i.media.currentTime:(new Date).getTime()/1e3;i.stage.context.clearRect(0,0,i.width,i.height);for(var n=i.runline.length-1;n>=0;n--){var h=i.runline[n];t-h.time>i.duration&&(h.canvas=null,i.runline.splice(n,1))}for(;i.position<i.comments.length&&i.comments[i.position].time<t;){var h=i.comments[i.position];h.canvas=r(h),("top"===h.mode||"bottom"===h.mode)&&(h.x=i.width-h.width>>1),h.y=i._getY(h),i.runline.push(h),++i.position}for(var n=i.runline.length-1;n>=0;n--){var h=i.runline[n],o=(i.width+h.width)*(t-h.time)/i.duration;"ltr"===h.mode&&(h.x=o-h.width+.5|0),"rtl"===h.mode&&(h.x=i.width-o+.5|0),i.stage.context.drawImage(h.canvas,h.x,h.y)}i.requestID=s(e)}if(!this.isHide&&this.paused){this.paused=!1;var i=this;this.requestID=s(this.useCanvas?e:t)}},e.prototype._pause=function(){this.isHide||this.paused||(this.paused=!0,n(this.requestID),this.requestID=0)},e.prototype._seek=function(){var t=this.isMedia?this.media.currentTime:(new Date).getTime()/1e3;this._clear(),this._resetRange(),this.position=h(this.comments,t)},e.prototype._clear=function(){if(this.useCanvas){this.stage.context.clearRect(0,0,this.width,this.height);for(var t=this.runline.length-1;t>=0;t--)this.runline[t].canvas=null}else for(var e=this.stage.lastChild;e;)this.stage.removeChild(e),e=this.stage.lastChild;this.runline=[]},e.prototype._getY=function(t){for(var e=this,i=this.isMedia?this.media.currentTime:(new Date).getTime()/1e3,s="_"+t.mode,n=this[s].length,h=0,o=0,a=function(t,s){if("top"===s.mode||"bottom"===s.mode)return i-t.time<e.duration;var n=(e.width+t.width)*(i-t.time)/e.duration,h=e.duration+t.time-i,o=e.duration*e.width/(e.width+s.width);return h>o||t.width>n},r=1;n>r;r++){var d,m=this[s][r];if(d="top"===t.mode||"bottom"===t.mode?t.height+m.height:t.height,m.range-this[s][h].range>d){o=r;break}a(m,t)&&(h=r)}var u=this[s][h].range,c={range:u+t.height,time:t.time,width:t.width,height:t.height};return this[s].splice(h+1,o-h-1,c),"bottom"===t.mode?this.height-t.height-u%this.height:u%(this.height-t.height)},e.prototype._resetRange=function(){this._ltr=new i,this._rtl=new i,this._top=new i,this._bottom=new i};var s=t.requestAnimationFrame||t.mozRequestAnimationFrame||t.webkitRequestAnimationFrame||function(t){return setTimeout(t,50/3)},n=t.cancelAnimationFrame||t.mozCancelAnimationFrame||t.webkitCancelAnimationFrame||function(t){clearTimeout(t)},h=function(t,e){for(var i,s=0,n=t.length;n>=s;)i=s+n>>1,e<=t[i].time?n=i-1:s=i+1;return 0>n&&(n=0),n},o=function(t){t.mode=(t.mode||"rtl").toLowerCase(),/ltr|top|bottom/.test(t.mode)||(t.mode="rtl")},a=function(t){var e=document.createElement("div");if(e.appendChild(document.createTextNode(t.text)),e.style.cssText="position:absolute;white-space:nowrap;",t.style)for(var i in t.style)e.style[i]=t.style[i];return e},r=function(t){var e=document.createElement("canvas"),i=e.getContext("2d"),s=t.canvasStyle&&t.canvasStyle.font||"10px sans-serif";if(i.font=s,e.width=t.width||i.measureText(t.text).width+.5|0,e.height=t.height||1.2*s.match(/(\d+)px/)[1]+.5|0,t.width=e.width,t.height=e.height,t.canvasStyle)for(var n in t.canvasStyle)i[n]=t.canvasStyle[n];return i.textBaseline="top",i.strokeText(t.text,0,0),i.fillText(t.text,0,0),e},d=function(t,e){for(var i=["","-o-","-ms-","-moz-","-webkit-"],s="transform:translate("+t+"px,"+e+"px);",n="",h=i.length-1;h>=0;h--)n+=i[h]+s;return n};t.Danmaku=e}(window);